<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Cobradores - <%= appSettings.companyHeader %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/responsive-admin.css" rel="stylesheet">
    <link href="/css/admin-mobile.css" rel="stylesheet">
    <style>
        /* Estilos mantidos para a aparência moderna */
        .collector-card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; margin-bottom: 1.5rem; }
        .collector-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .collector-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0; padding: 1.5rem; }
        .collector-name { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .collector-phone { font-size: 0.9rem; opacity: 0.9; }
        .collector-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding: 1rem; background: #f8f9fa; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #2c3e50; }
        .stat-label { font-size: 0.8rem; color: #6c757d; }
        .collector-actions { padding: 1rem; border-top: 1px solid #e9ecef; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .floating-add-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: linear-gradient(135deg, #28a745, #1e7e34); border: none; border-radius: 50%; color: white; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(40,167,69,0.4); cursor: pointer; transition: all 0.3s ease; z-index: 1000; }
        .floating-add-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(40,167,69,0.6); }
        .search-section { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .empty-state { text-align: center; padding: 4rem 2rem; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <%- include('../partials/billing-sidebar') %>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="bi bi-person-check me-2"></i>Gerenciar Cobradores</h1>
                    <div>
                        <a href="/admin/collectors/add" class="btn btn-success"><i class="bi bi-plus me-2"></i>Adicionar Cobrador</a>
                    </div>
                </div>

                <div class="search-section">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <div class="position-relative"><i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                                <input type="text" class="form-control ps-5" placeholder="Buscar cobrador por nome ou telefone..." id="searchInput">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="statusFilter">
                                <option value="all">Todos os Status</option>
                                <option value="active">Ativo</option>
                                <option value="inactive">Inativo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="collectorsList" class="row">
                    <% if (collectors && collectors.length > 0) { %>
                        <% collectors.forEach(function(collector) { %>
                            <div class="col-lg-6 collector-card-wrapper" data-status="<%= collector.status || 'active' %>" data-name="<%= collector.name.toLowerCase() %>" data-phone="<%= collector.phone %>">
                                <div class="collector-card">
                                    <div class="collector-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="collector-name"><%= collector.name %></div>
                                                <div class="collector-phone"><i class="bi bi-telephone me-1"></i><%= collector.phone %></div>
                                            </div>
                                            <span class="status-badge status-<%= collector.status || 'active' %>">
                                                <%= collector.status === 'active' ? 'Ativo' : 'Inativo' %>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="collector-stats">
                                        <div class="stat-item"><div class="stat-value text-success"><%= collector.total_payments || 0 %></div><div class="stat-label">Pagamentos</div></div>
                                        <div class="stat-item"><div class="stat-value text-warning">R$ <%= collector.total_commission ? collector.total_commission.toLocaleString('pt-BR') : '0' %></div><div class="stat-label">Comissão</div></div>
                                        <div class="stat-item"><div class="stat-value text-info"><%= collector.commission_rate || 5 %>%</div><div class="stat-label">Taxa</div></div>
                                    </div>
                                    <div class="collector-actions d-flex justify-content-between align-items-center">
                                         <small class="text-muted"><i class="bi bi-envelope me-1"></i><%= collector.email || 'N/A' %></small>
                                        <div>
                                            <a href="/admin/collectors/<%= collector.id %>/edit" class="btn btn-outline-primary btn-sm me-2"><i class="bi bi-pencil me-1"></i>Editar</a>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCollector('<%= collector.id %>')"><i class="bi bi-trash me-1"></i>Excluir</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="col-12">
                            <div class="empty-state card card-body">
                                <i class="bi bi-person-check"></i>
                                <h4>Nenhum cobrador encontrado</h4>
                                <p>Comece adicionando o primeiro cobrador da sua equipe.</p>
                                <a href="/admin/collectors/add" class="btn btn-primary"><i class="bi bi-plus me-2"></i>Adicionar Cobrador</a>
                            </div>
                        </div>
                    <% } %>
                     <div id="no-results" class="col-12" style="display: none;">
                        <div class="empty-state card card-body">
                            <i class="bi bi-search"></i>
                            <h4>Nenhum resultado</h4>
                            <p>Nenhum cobrador corresponde à sua busca ou filtro.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <a href="/admin/collectors/add" class="floating-add-btn" title="Adicionar Cobrador"><i class="bi bi-plus"></i></a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function deleteCollector(id) {
            if (confirm('Tem certeza que deseja excluir este cobrador?')) {
                fetch(`/admin/collectors/${id}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Cobrador excluído com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro: ' + (data.message || 'Falha ao excluir cobrador'));
                    }
                }).catch(() => alert('Ocorreu um erro de rede.'));
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');

            function filterCollectors() {
                const searchTerm = searchInput.value.toLowerCase();
                const status = statusFilter.value;
                const cards = document.querySelectorAll('.collector-card-wrapper');
                let visibleCount = 0;

                cards.forEach(card => {
                    const name = card.dataset.name;
                    const phone = card.dataset.phone;
                    const cardStatus = card.dataset.status;
                    
                    const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                    const matchesStatus = status === 'all' || cardStatus === status;

                    if (matchesSearch && matchesStatus) {
                        card.style.display = '';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                document.getElementById('no-results').style.display = visibleCount === 0 ? '' : 'none';
            }

            searchInput.addEventListener('input', filterCollectors);
            statusFilter.addEventListener('change', filterCollectors);
        });
    </script>
</body>
</html>
