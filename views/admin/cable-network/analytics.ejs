<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Portal do Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <link href="/css/admin-mobile.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-card { transition: transform 0.2s; }
        .analytics-card:hover { transform: translateY(-2px); }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .metric-card.success { background: linear-gradient(135deg, #06d6a0 0%, #118ab2 100%); }
        .metric-card.warning { background: linear-gradient(135deg, #ffd166 0%, #fd7e14 100%); }
        .metric-card.danger { background: linear-gradient(135deg, #ef476f 0%, #8e44ad 100%); }
        .metric-card.info { background: linear-gradient(135deg, #118ab2 0%, #667eea 100%); }
        .chart-container { position: relative; height: 300px; margin-bottom: 2rem; }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle { transition: stroke-dasharray 0.35s; transform-origin: 50% 50%; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-connected { background-color: #06d6a0; }
        .status-disconnected { background-color: #ef476f; }
        .status-maintenance { background-color: #ffd166; }
        .status-damaged { background-color: #8e44ad; }
        .heatmap-container { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .heatmap-cell { width: 20px; height: 20px; border-radius: 4px; margin: 2px; display: inline-block; cursor: pointer; transition: transform 0.2s; }
        .heatmap-cell:hover { transform: scale(1.2); }
        .heatmap-legend { display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin"><i class="bx bx-wifi"></i> Portal do Admin</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin"><i class="bx bx-home"></i> Painel</a>
                <a class="nav-link" href="/admin/cable-network/odp"><i class="bx bx-broadcast"></i> Gerenciar ODP</a>
                <a class="nav-link" href="/admin/cable-network/cables"><i class="bx bx-cable-car"></i> Rotas de Cabos</a>
                <a class="nav-link active" href="/admin/cable-network/analytics"><i class="bx bx-bar-chart-alt-2"></i> Análise</a>
                <a class="nav-link" href="/admin/billing/mapping"><i class="bx bx-map"></i> Visualização do Mapa</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="bx bx-bar-chart-alt-2"></i> Análise da Rede de Cabos</h2>
                        <p class="text-muted">Análises avançadas e insights para o gerenciamento da rede de cabos</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="refreshAnalytics()"><i class="bx bx-refresh"></i> Atualizar</button>
                        <button class="btn btn-primary" onclick="exportReport()"><i class="bx bx-download"></i> Exportar Relatório</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card success"><div class="d-flex justify-content-between align-items-center"><div><h4 id="totalODPs">-</h4><p class="mb-0">Total de ODPs</p></div><div class="align-self-center"><i class="bx bx-broadcast fs-1"></i></div></div></div>
            </div>
            <div class="col-md-3">
                <div class="metric-card info"><div class="d-flex justify-content-between align-items-center"><div><h4 id="totalCables">-</h4><p class="mb-0">Total de Cabos</p></div><div class="align-self-center"><i class="bx bx-cable-car fs-1"></i></div></div></div>
            </div>
            <div class="col-md-3">
                <div class="metric-card warning"><div class="d-flex justify-content-between align-items-center"><div><h4 id="utilizationRate">-%</h4><p class="mb-0">Taxa de Utilização</p></div><div class="align-self-center"><i class="bx bx-trending-up fs-1"></i></div></div></div>
            </div>
            <div class="col-md-3">
                <div class="metric-card danger"><div class="d-flex justify-content-between align-items-center"><div><h4 id="healthScore">-%</h4><p class="mb-0">Saúde da Rede</p></div><div class="align-self-center"><i class="bx bx-heart fs-1"></i></div></div></div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="analytics-card card">
                    <div class="card-header"><h5 class="mb-0"><i class="bx bx-pie-chart-alt-2"></i> Distribuição de Capacidade dos ODPs</h5></div>
                    <div class="card-body"><div class="chart-container"><canvas id="odpCapacityChart"></canvas></div></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="analytics-card card">
                    <div class="card-header"><h5 class="mb-0"><i class="bx bx-bar-chart"></i> Distribuição de Status dos Cabos</h5></div>
                    <div class="card-body"><div class="chart-container"><canvas id="cableStatusChart"></canvas></div></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="analytics-card card">
                    <div class="card-header"><h5 class="mb-0"><i class="bx bx-trending-up"></i> Tendência de Utilização da Rede</h5></div>
                    <div class="card-body"><div class="chart-container"><canvas id="utilizationTrendChart"></canvas></div></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="analytics-card card">
                    <div class="card-header"><h5 class="mb-0"><i class="bx bx-trophy"></i> Principais ODPs por Uso</h5></div>
                    <div class="card-body" id="topODPsList"><div class="text-center"><i class="bx bx-loader-alt bx-spin fs-1 text-muted"></i><p class="text-muted">Carregando...</p></div></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="heatmap-container">
                    <h5 class="mb-3"><i class="bx bx-grid-alt"></i> Mapa de Calor de Capacidade dos ODPs</h5>
                    <div id="odpHeatmap" class="mb-3"><div class="text-center"><i class="bx bx-loader-alt bx-spin fs-1 text-muted"></i><p class="text-muted">Carregando mapa de calor...</p></div></div>
                    <div class="heatmap-legend">
                        <span class="text-muted">Uso de Capacidade:</span>
                        <div class="legend-item"><div class="heatmap-cell" style="background-color: #06d6a0;"></div><span>0-30%</span></div>
                        <div class="legend-item"><div class="heatmap-cell" style="background-color: #ffd166;"></div><span>30-70%</span></div>
                        <div class="legend-item"><div class="heatmap-cell" style="background-color: #fd7e14;"></div><span>70-90%</span></div>
                        <div class="legend-item"><div class="heatmap-cell" style="background-color: #ef476f;"></div><span>90-100%</span></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="analytics-card card">
                    <div class="card-header"><h5 class="mb-0"><i class="bx bx-error-circle"></i> Alertas e Recomendações</h5></div>
                    <div class="card-body" id="alertsList"><div class="text-center"><i class="bx bx-loader-alt bx-spin fs-1 text-muted"></i><p class="text-muted">Carregando alertas...</p></div></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let analyticsData = null, charts = {};
        async function loadAnalyticsData() {
            try {
                const response = await fetch('/admin/cable-network/api/analytics');
                const result = await response.json();
                if (result.success) {
                    analyticsData = result.data;
                    updateMetrics();
                    renderCharts();
                    renderHeatmap();
                    renderAlerts();
                    renderTopODPs();
                } else { console.error('Falha ao carregar dados de análise:', result.message); }
            } catch (error) { console.error('Erro ao carregar dados de análise:', error); }
        }
        function updateMetrics() {
            if (!analyticsData) return;
            document.getElementById('totalODPs').textContent = analyticsData.odps.total || 0;
            document.getElementById('totalCables').textContent = analyticsData.cables.total || 0;
            document.getElementById('utilizationRate').textContent = (analyticsData.utilization || 0).toFixed(1) + '%';
            document.getElementById('healthScore').textContent = (analyticsData.healthScore || 0).toFixed(1) + '%';
        }
        function renderCharts() {
            if (!analyticsData) return;
            const odpCapacityCtx = document.getElementById('odpCapacityChart').getContext('2d');
            charts.odpCapacity = new Chart(odpCapacityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Saudável (< 70%)', 'Atenção (70-90%)', 'Crítico (> 90%)'],
                    datasets: [{ data: [analyticsData.odps.healthy || 0, analyticsData.odps.warning || 0, analyticsData.odps.critical || 0], backgroundColor: ['#06d6a0', '#ffd166', '#ef476f'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
            const cableStatusCtx = document.getElementById('cableStatusChart').getContext('2d');
            charts.cableStatus = new Chart(cableStatusCtx, {
                type: 'bar',
                data: {
                    labels: ['Conectado', 'Desconectado', 'Em Manutenção', 'Danificado'],
                    datasets: [{ label: 'Contagem de Cabos', data: [analyticsData.cables.connected || 0, analyticsData.cables.disconnected || 0, analyticsData.cables.maintenance || 0, analyticsData.cables.damaged || 0], backgroundColor: ['#06d6a0', '#ef476f', '#ffd166', '#8e44ad'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
            const utilizationCtx = document.getElementById('utilizationTrendChart').getContext('2d');
            charts.utilizationTrend = new Chart(utilizationCtx, {
                type: 'line',
                data: {
                    labels: analyticsData.utilizationTrend?.labels || ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [{ label: 'Utilização %', data: analyticsData.utilizationTrend?.data || [65, 70, 75, 68, 72, 78], borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4, fill: true }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }
        function renderHeatmap() {
            if (!analyticsData || !analyticsData.odps.heatmap) return;
            const heatmapContainer = document.getElementById('odpHeatmap');
            heatmapContainer.innerHTML = '';
            analyticsData.odps.heatmap.forEach(odp => {
                const percentage = (odp.used_ports / odp.capacity) * 100;
                let color = '#06d6a0';
                if (percentage >= 90) color = '#ef476f';
                else if (percentage >= 70) color = '#fd7e14';
                else if (percentage >= 30) color = '#ffd166';
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.style.backgroundColor = color;
                cell.title = `${odp.name}: ${percentage.toFixed(1)}% (${odp.used_ports}/${odp.capacity})`;
                cell.onclick = () => showODPDetails(odp);
                heatmapContainer.appendChild(cell);
            });
        }
        function renderAlerts() {
            if (!analyticsData || !analyticsData.alerts) return;
            const alertsContainer = document.getElementById('alertsList');
            alertsContainer.innerHTML = '';
            analyticsData.alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${alert.type} alert-sm mb-2`;
                alertDiv.innerHTML = `<div class="d-flex align-items-start"><i class="bx ${alert.icon} me-2 mt-1"></i><div><strong>${alert.title}</strong><div class="small">${alert.message}</div></div></div>`;
                alertsContainer.appendChild(alertDiv);
            });
        }
        function renderTopODPs() {
            if (!analyticsData || !analyticsData.topODPs) return;
            const topODPsContainer = document.getElementById('topODPsList');
            topODPsContainer.innerHTML = '';
            analyticsData.topODPs.forEach((odp, index) => {
                const percentage = (odp.used_ports / odp.capacity) * 100;
                const odpDiv = document.createElement('div');
                odpDiv.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded';
                odpDiv.innerHTML = `<div><div class="fw-bold">${odp.name}</div><small class="text-muted">${odp.used_ports}/${odp.capacity} portas</small></div><div class="text-end"><div class="fw-bold text-${percentage >= 90 ? 'danger' : percentage >= 70 ? 'warning' : 'success'}">${percentage.toFixed(1)}%</div><div class="badge bg-primary">#${index + 1}</div></div>`;
                topODPsContainer.appendChild(odpDiv);
            });
        }
        function showODPDetails(odp) { alert(`Detalhes do ODP:\nNome: ${odp.name}\nCódigo: ${odp.code}\nCapacidade: ${odp.used_ports}/${odp.capacity}\nUso: ${((odp.used_ports / odp.capacity) * 100).toFixed(1)}%`); }
        function refreshAnalytics() { loadAnalyticsData(); }
        function exportReport() { alert('A funcionalidade de exportação estará disponível em breve'); }
        document.addEventListener('DOMContentLoaded', function() { loadAnalyticsData(); });
    </script>
</body>
</html>
