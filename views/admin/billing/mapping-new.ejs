<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa da Rede - Admin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/responsive-admin.css" rel="stylesheet">
    <link href="/css/admin-mobile.css" rel="stylesheet">
    <style>
        #map {
            height: 75vh;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .search-bar {
            background: #fff;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        .loading-overlay { z-index: 1001; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <%- include('../../partials/admin-responsive-sidebar', { page: 'mapping-new' }) %>

            <main class="col-md-10 ms-sm-auto main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="bi bi-map-fill me-2"></i>Mapa da Rede</h1>
                </div>

                <div class="search-bar">
                    <form id="searchClientForm">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-5">
                                <input type="text" class="form-control" id="searchValue" placeholder="Digite para buscar...">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="searchType">
                                    <option value="name">Nome do Cliente</option>
                                    <option value="cpf">CPF</option>
                                    <option value="phone">Telefone</option>
                                    <option value="code">Código do Cliente</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Buscar Cliente</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="map"></div>
                 <div id="loading" class="loading-overlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); align-items: center; justify-content: center;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let map;
        let customerMarkers = L.layerGroup();

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadAllCustomers();

            document.getElementById('searchClientForm').addEventListener('submit', (e) => {
                e.preventDefault();
                searchClient();
            });
        });

        function initMap() {
            map = L.map('map').setView([-14.235, -51.925], 4); // Centro do Brasil

            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3'],
                attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>'
            });

            const baseMaps = {
                "Padrão": osm,
                "Satélite": googleSat
            };

            osm.addTo(map); // Camada padrão
            L.control.layers(baseMaps).addTo(map);
            
            customerMarkers.addTo(map);
        }

        async function loadAllCustomers() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const response = await fetch('/admin/api/clients'); 
                const result = await response.json();
                if (result.clients) {
                    result.clients.forEach(addCustomerToMap);
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function addCustomerToMap(client) {
            if (client.latitude && client.longitude) {
                const marker = L.marker([client.latitude, client.longitude])
                    .bindPopup(`<b>${client.name}</b><br>${client.address}`)
                    .addTo(customerMarkers);
                marker.options.clientId = client.id; 
            }
        }

        async function searchClient() {
            const type = document.getElementById('searchType').value;
            const value = document.getElementById('searchValue').value.trim();

            if (!value) {
                alert('Por favor, insira um valor para a busca.');
                return;
            }

            document.getElementById('loading').style.display = 'flex';

            try {
                const response = await fetch(`/admin/api/clients/search?type=${type}&value=${encodeURIComponent(value)}`);
                const result = await response.json();

                if (result.success && result.client) {
                    const client = result.client;
                    if (client.latitude && client.longitude) {
                        map.flyTo([client.latitude, client.longitude], 16);
                        
                        customerMarkers.eachLayer(marker => {
                            if (marker.options.clientId === client.id) {
                                marker.openPopup();
                            }
                        });

                    } else {
                        alert('Cliente encontrado, mas não possui coordenadas de mapa cadastradas.');
                    }
                } else {
                    alert('Cliente não encontrado. Verifique os dados e tente novamente.');
                }
            } catch (error) {
                console.error('Erro na busca:', error);
                alert('Ocorreu um erro ao se comunicar com o servidor.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>
