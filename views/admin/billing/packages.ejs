<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Planos de Internet - Portal Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="/css/admin-mobile.css" rel="stylesheet">
    <style>
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <%- include('../../partials/billing-sidebar') %>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bx bx-package"></i> Gerenciar Planos de Internet
                    </h1>
                    <div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPackageModal">
                            <i class="bx bx-plus"></i> Adicionar Plano
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bx bx-list-ul"></i> Lista de Planos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="packagesTable" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nome do Plano</th>
                                        <th>Velocidade</th>
                                        <th>Preço (Base)</th>
                                        <th>Imposto</th>
                                        <th>Preço (Final)</th>
                                        <th>Perfil PPPoE</th>
                                        <th>Descrição</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (packages && packages.length > 0) { %>
                                        <% packages.forEach(function(pkg) { %>
                                            <tr>
                                                <td>
                                                    <span class="text-body fw-bold"><%= pkg.name %></span>
                                                </td>
                                                <td><%= pkg.speed %></td>
                                                <td>R$ <%= parseFloat(pkg.price).toLocaleString('pt-BR') %></td>
                                                <td>
                                                    <% const taxRate = (pkg.tax_rate === 0 || (typeof pkg.tax_rate === 'number' && pkg.tax_rate > -1)) ? Number(pkg.tax_rate) : 11.00; %>
                                                    <% if (taxRate === 0) { %>
                                                        <span class="badge bg-secondary">0% (Isento)</span>
                                                    <% } else { %>
                                                        <span class="badge bg-warning"><%= taxRate.toFixed(2) %>%</span>
                                                    <% } %>
                                                </td>
                                                <td class="text-success fw-bold">
                                                    R$ <%= (parseFloat(pkg.price) * (1 + taxRate / 100)).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                                                </td>
                                                <td><span class="badge bg-info"><%= pkg.pppoe_profile || 'default' %></span></td>
                                                <td><%= pkg.description || '-' %></td>
                                                <td>
                                                    <span class="badge bg-success">Ativo</span>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-primary" onclick="editPackage('<%= pkg.id %>')" title="Editar">
                                                            <i class="bx bx-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-info" onclick="viewPackage('<%= pkg.id %>')" title="Visualizar">
                                                            <i class="bx bx-show"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" onclick="deletePackage('<%= pkg.id %>')" title="Excluir">
                                                            <i class="bx bx-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Adicionar Plano -->
    <div class="modal fade" id="addPackageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Novo Plano</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addPackageForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nome do Plano</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="speed" class="form-label">Velocidade</label>
                            <input type="text" class="form-control" id="speed" name="speed" placeholder="Ex: 10 Mbps" required>
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label">Preço (Base)</label>
                            <input type="number" class="form-control" id="price" name="price" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_tax" name="enable_tax">
                                <label class="form-check-label" for="enable_tax">Habilitar Imposto</label>
                            </div>
                        </div>
                        <div class="mb-3" id="tax_rate_group" style="display:none;">
                            <label for="tax_rate" class="form-label">Imposto (%)</label>
                            <input type="number" class="form-control" id="tax_rate" name="tax_rate" step="0.01" min="0" max="100" value="11.00">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preço com Imposto</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" id="price_with_tax" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Descrição</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="pppoe_profile" class="form-label">Perfil PPPoE</label>
                            <div class="input-group">
                                <select class="form-select" id="pppoe_profile" name="pppoe_profile"></select>
                                <button class="btn btn-outline-secondary" type="button" id="reloadProfilesAdd">Recarregar</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Plano</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Plano -->
    <div class="modal fade" id="editPackageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Plano</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editPackageForm">
                    <div class="modal-body">
                        <input type="hidden" id="edit_package_id" name="package_id">
                        <div class="mb-3">
                            <label for="edit_name" class="form-label">Nome do Plano</label>
                            <input type="text" class="form-control" id="edit_name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_speed" class="form-label">Velocidade</label>
                            <input type="text" class="form-control" id="edit_speed" name="speed" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_price" class="form-label">Preço (Base)</label>
                            <input type="number" class="form-control" id="edit_price" name="price" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit_enable_tax" name="enable_tax">
                                <label class="form-check-label" for="edit_enable_tax">Habilitar Imposto</label>
                            </div>
                        </div>
                        <div class="mb-3" id="edit_tax_rate_group" style="display:none;">
                            <label for="edit_tax_rate" class="form-label">Imposto (%)</label>
                            <input type="number" class="form-control" id="edit_tax_rate" name="tax_rate" step="0.01" min="0" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preço com Imposto</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" id="edit_price_with_tax" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit_description" class="form-label">Descrição</label>
                            <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit_pppoe_profile" class="form-label">Perfil PPPoE</label>
                            <div class="input-group">
                                <select class="form-select" id="edit_pppoe_profile" name="pppoe_profile"></select>
                                <button class="btn btn-outline-secondary" type="button" id="reloadProfilesEdit">Recarregar</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Atualizar Plano</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Visualizar Plano -->
    <div class="modal fade" id="viewPackageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Plano</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="packageDetails"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#packagesTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
                },
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
            });
            loadPPPoEProfiles('#pppoe_profile');
            $('#reloadProfilesAdd').on('click', () => loadPPPoEProfiles('#pppoe_profile'));
            $('#reloadProfilesEdit').on('click', () => loadPPPoEProfiles('#edit_pppoe_profile'));
            initializeTaxCalculation();
        });

        function initializeTaxCalculation() {
            const fields = ['price', 'tax_rate', 'enable_tax'];
            const editFields = ['edit_price', 'edit_tax_rate', 'edit_enable_tax'];

            $(`#${fields.join(', #')}`).on('input change', () => calculatePriceWithTax('price', 'tax_rate', 'price_with_tax', 'enable_tax'));
            $(`#${editFields.join(', #')}`).on('input change', () => calculatePriceWithTax('edit_price', 'edit_tax_rate', 'edit_price_with_tax', 'edit_enable_tax'));

            $('#enable_tax').on('change', function() { $('#tax_rate_group').toggle(this.checked); });
            $('#edit_enable_tax').on('change', function() { $('#edit_tax_rate_group').toggle(this.checked); });
        }

        function calculatePriceWithTax(priceId, taxId, resultId, checkboxId) {
            const price = parseFloat($('#' + priceId).val()) || 0;
            let taxRate = 0;
            if ($('#' + checkboxId).is(':checked')) {
                taxRate = parseFloat($('#' + taxId).val()) || 0;
            }
            const priceWithTax = price * (1 + taxRate / 100);
            $('#' + resultId).val(priceWithTax.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
        }

        function loadPPPoEProfiles(selector, selectedValue) {
            const select = $(selector);
            select.html('<option>Carregando...</option>');
            fetch('/admin/mikrotik/profiles/api')
                .then(r => r.json())
                .then(data => {
                    select.empty();
                    const names = Array.from(new Set((data.profiles || []).map(p => p.name).filter(Boolean)));
                    if (!names.includes('default')) names.unshift('default');
                    names.forEach(name => select.append($('<option>', { value: name, text: name })));
                    if (selectedValue) select.val(selectedValue);
                }).catch(err => {
                    select.html('<option value="default">default</option>');
                    showAlert('danger', 'Falha ao carregar perfis PPPoE.');
                });
        }

        $('#addPackageForm').on('submit', function(e) {
            e.preventDefault();
            const formData = {
                name: $('#name').val(),
                speed: $('#speed').val(),
                price: parseFloat($('#price').val()),
                tax_rate: $('#enable_tax').is(':checked') ? parseFloat($('#tax_rate').val()) : 0,
                description: $('#description').val(),
                pppoe_profile: $('#pppoe_profile').val() || 'default'
            };
            submitForm('/admin/billing/packages', 'POST', formData, 'Plano adicionado com sucesso', '#addPackageModal');
        });

        function editPackage(id) {
            fetch(`/admin/billing/api/packages/${id}`)
                .then(r => r.json()).then(data => {
                    if(data.success) {
                        const pkg = data.package;
                        $('#edit_package_id').val(pkg.id);
                        $('#edit_name').val(pkg.name);
                        $('#edit_speed').val(pkg.speed);
                        $('#edit_price').val(pkg.price);
                        const taxRate = pkg.tax_rate || 0;
                        $('#edit_enable_tax').prop('checked', taxRate > 0).trigger('change');
                        $('#edit_tax_rate').val(taxRate);
                        $('#edit_description').val(pkg.description);
                        calculatePriceWithTax('edit_price', 'edit_tax_rate', 'edit_price_with_tax', 'edit_enable_tax');
                        loadPPPoEProfiles('#edit_pppoe_profile', pkg.pppoe_profile);
                        new bootstrap.Modal($('#editPackageModal')).show();
                    } else showAlert('danger', data.message);
            }).catch(() => showAlert('danger', 'Erro ao buscar dados do plano.'));
        }

        $('#editPackageForm').on('submit', function(e) {
            e.preventDefault();
            const id = $('#edit_package_id').val();
            const formData = {
                name: $('#edit_name').val(),
                speed: $('#edit_speed').val(),
                price: parseFloat($('#edit_price').val()),
                tax_rate: $('#edit_enable_tax').is(':checked') ? parseFloat($('#edit_tax_rate').val()) : 0,
                description: $('#edit_description').val(),
                pppoe_profile: $('#edit_pppoe_profile').val() || 'default'
            };
            submitForm(`/admin/billing/packages/${id}`, 'PUT', formData, 'Plano atualizado com sucesso', '#editPackageModal');
        });

        function viewPackage(id) {
            fetch(`/admin/billing/api/packages/${id}`)
                .then(r => r.json()).then(data => {
                    if(data.success) {
                        const pkg = data.package;
                        const taxRate = (pkg.tax_rate === 0 || pkg.tax_rate) ? Number(pkg.tax_rate) : 11;
                        const finalPrice = (parseFloat(pkg.price) * (1 + taxRate / 100));
                        const details = `
                            <p><strong>Nome:</strong> ${pkg.name}</p>
                            <p><strong>Velocidade:</strong> ${pkg.speed}</p>
                            <p><strong>Preço Base:</strong> R$ ${parseFloat(pkg.price).toLocaleString('pt-BR')}</p>
                            <p><strong>Imposto:</strong> ${taxRate.toFixed(2)}%</p>
                            <p><strong>Preço Final:</strong> R$ ${finalPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <p><strong>Perfil PPPoE:</strong> ${pkg.pppoe_profile || 'default'}</p>
                            <p><strong>Descrição:</strong> ${pkg.description || 'N/A'}</p>`;
                        $('#packageDetails').html(details);
                        new bootstrap.Modal($('#viewPackageModal')).show();
                    } else showAlert('danger', data.message);
            }).catch(() => showAlert('danger', 'Erro ao buscar detalhes do plano.'));
        }

        function deletePackage(id) {
            if (confirm('Tem certeza que deseja excluir este plano? Esta ação não pode ser desfeita.')) {
                submitForm(`/admin/billing/packages/${id}`, 'DELETE', null, 'Plano excluído com sucesso');
            }
        }

        function submitForm(url, method, data, successMessage, modalId) {
            const options = {
                method: method,
                headers: method !== 'DELETE' ? { 'Content-Type': 'application/json' } : {},
            };
            if (data) options.body = JSON.stringify(data);

            fetch(url, options).then(r => r.json()).then(res => {
                if (res.success) {
                    showAlert('success', successMessage);
                    if (modalId) $(modalId).modal('hide');
                    setTimeout(() => location.reload(), 800);
                } else {
                    showAlert('danger', res.message || 'Ocorreu um erro.');
                }
            }).catch(err => showAlert('danger', `Erro de comunicação: ${err.message}`))
        }

        function showAlert(type, message) {
            const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
            $('.main-content').prepend(alertHtml);
            window.scrollTo(0, 0);
            setTimeout(() => $('.alert').alert('close'), 5000);
        }
    </script>
</body>
</html>
